/**
 * Created by Daniel on 1/29/2017.
 */

var windowSize = {width: $(window).width(), height: $(window).height()};
var canvas = new fabric.Canvas('mainCanvas',{width: windowSize.width, height: windowSize.height});
var canvasW = canvas.getWidth();

function PercentW(perc) {
    return windowSize.width*(perc/100);
}
function PercentH(perc) {
    return windowSize.height*(perc/100);
}
function ObjectIsInZones(O,zones) {
    for (var i=0; i<zones.length; i++)
        {
        if (ObjectIsInZone(O,zones[i]))
            return 1;
        }
    return 0;
}

function ObjectIsInZone(O,zone) {
    if (O.left>=zone.l && O.left+O.width<=zone.r && O.top>=zone.t && O.top+O.height<=zone.b)
        return 1;
    return 0;
}

function makeBetweenLine(coords) {
    return new fabric.Line(coords, {
        fill: 'black',
        stroke: 'black',
        strokeWidth: 3,
        selectable: false
    });
}

function LineBetween(Main,Secondary) {
    var zoneUp = {l:Main.left,r:Main.left+Main.width,t:0,b:Main.top};
    var zoneLeft = {l:0,r:Main.left,t:Main.top,b:Main.top+Main.height};
    var zoneRight = {l:Main.left+Main.width,r:windowSize.width,t:Main.top,b:Main.top+Main.height};
    var zoneDown = {l:Main.left,r:Main.left+Main.width,t:Main.top+Main.height,b:windowSize.height};
    if (ObjectIsInZones(Secondary,[zoneUp,zoneDown,zoneLeft,zoneRight]))
        {
        if (ObjectIsInZone(Secondary,zoneLeft))
            {
            canvas.add(makeBetweenLine([
                Secondary.left+Secondary.width,
                Secondary.top+(Secondary.height/2),
                Main.left,
                Secondary.top+(Secondary.height/2),
            ]));
            }
        if (ObjectIsInZone(Secondary,zoneRight))
            {
            canvas.add(makeBetweenLine([
                Secondary.left,
                Secondary.top+(Secondary.height/2),
                Main.left+Main.width,
                Secondary.top+(Secondary.height/2),
            ]));
            }
        if (ObjectIsInZone(Secondary,zoneUp))
            {
            canvas.add(makeBetweenLine([
                Secondary.left+Secondary.width/2,
                Secondary.top+Secondary.height,
                Secondary.left+Secondary.width/2,
                Main.top,
            ]));
            }
        if (ObjectIsInZone(Secondary,zoneDown))
            {
            canvas.add(makeBetweenLine([
                Secondary.left+Secondary.width/2,
                Main.top+Main.height,
                Secondary.left+Secondary.width/2,
                Secondary.top
            ]));
            }
        }

    var zoneUpLeft = {l:0,r:Main.left,t:0,b:Main.top};
    var zoneUpRight = {l:Main.left+Main.width,r:windowSize.width,t:0,b:Main.top};
    var zoneDownLeft = {l:0,r:Main.left,t:Main.top+Main.height,b:windowSize.height};
    var zoneDownRight = {l:Main.left+Main.width,r:windowSize.width,t:Main.top+Main.height,b:windowSize.height};

    if (ObjectIsInZones(Secondary,[zoneUpLeft,zoneUpRight,zoneDownLeft,zoneDownRight]))
        {
        if (ObjectIsInZone(Secondary,zoneUpLeft))
            {
            canvas.add(makeBetweenLine([
                Secondary.left+Secondary.width,
                Secondary.top+Secondary.height,
                Main.left,
                Main.top,
            ]));
            }
        if (ObjectIsInZone(Secondary,zoneUpRight))
            {
            canvas.add(makeBetweenLine([
                Secondary.left,
                Secondary.top+Secondary.height,
                Main.left+Main.width,
                Main.top,
            ]));
            }
        if (ObjectIsInZone(Secondary,zoneDownLeft))
            {
            canvas.add(makeBetweenLine([
                Secondary.left+Secondary.width,
                Secondary.top,
                Main.left,
                Main.top+Main.height,
            ]));
            }
        if (ObjectIsInZone(Secondary,zoneDownRight))
            {
            canvas.add(makeBetweenLine([
                Secondary.left,
                Secondary.top,
                Main.left+Main.width,
                Main.top+Main.height,
            ]));
            }
        }
}

// create a rectangle object
var rect = new fabric.Rect({
    stroke: 'black',
    fill: 'white',
    originX: 'center',
    originY: 'center',
    width: PercentW(40),
    height: PercentH(30)
});

var text = new fabric.Text('main one', {
   fontSize: 30,
    originX: 'center',
    originY: 'center',
});

var mainRect = new fabric.Group([rect,text], {
    originX: 'left',
    originY: 'top',
    left: PercentW(50)-rect.width/2,
    top: PercentH(50)-rect.height/2
});
/*
canvas.on('mouse:over', function(e) {
    if (typeof(e.target)=='object') {
        e.target.item(0).setStroke('red');
        canvas.renderAll();
    }
});

canvas.on('mouse:out', function(e) {
    if (typeof(e.target)=='object'){
        e.target.item(0).setStroke('black');
        canvas.renderAll();
    }
});*/
canvas.on('mouse:down', function(options) {
    console.log(options.e.clientX, options.e.clientY);
});

var text = new fabric.Text('secondary oneeeeeeeeee', {
    fontSize: 20,
    originX: 'center',
    originY: 'center',
});

var rect = new fabric.Rect({
    stroke: 'black',
    fill: 'white',
    originX: 'center',
    originY: 'center',
    width: text.getWidth()+10,
    height: text.getHeight()+10,
});

var secondaryRect = new fabric.Group([rect,text], {
    originX: 'left',
    originY: 'top',
    left: PercentW(80)-rect.width/2,
    top: PercentH(80)-rect.height/2
});

mainRect.set('selectable', false);
// "add" rectangle onto canvas
canvas.add(mainRect);
canvas.add(secondaryRect);
canvas.renderAll();

LineBetween(mainRect,secondaryRect);